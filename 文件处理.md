# 文件处理

## web上传和下载

### 文件上传

```java
   @PostMapping("/upload")
    public String uploadFile(@RequestBody MultipartFile file) {
        if (!file.isEmpty()) {
            String fileName = file.getOriginalFilename();
            long size = file.getSize();
            // 处理文件保存逻辑
            // ...
            return "File uploaded successfully! file name is :"+fileName+" file size is :"+size/1024/1024 +"MB";
        } else {
            return "No file selected!";
        }
    }
```

---

#### 报错

> `the field file exceeds its maximum permitted size of 1048576 bytes.`
>
> 显示上传文件大小超过允许范围,原因是 SpringBoot内嵌的 tomcat 默认的所有上传的文件大小为 1MB，超出这个大小就会报错.

![image-20230608102713277](https://wang-rich.oss-cn-hangzhou.aliyuncs.com/md/image-20230608102713277.png)

#### 解决

解决这个问题需要更改以下两个默认。

- **multipart.maxFileSize**
- **multipart.maxRequestSize**

SpringBoot 1.3.x 之前

```yml
multipart:
    maxFileSize: 50Mb
    maxRequestSize: 50Mb
```

SpringBoot 1.4.x

```yml
spring:
    http:
        multipart:
            maxFileSize: 50Mb
            maxRequestSize: 50Mb
```

SpringBoot 2.0.x之后

```yml
spring:
    servlet:
        multipart:
            max-file-size: 50MB
            max-request-size: 50MB
```

这里我使用的是3.0.2的版本

![image-20230608103344277](https://wang-rich.oss-cn-hangzhou.aliyuncs.com/md/image-20230608103344277.png)

进行了以下配置

![image-20230608103157523](https://wang-rich.oss-cn-hangzhou.aliyuncs.com/md/image-20230608103157523.png)

结果请求成功

![image-20230608103804470](https://wang-rich.oss-cn-hangzhou.aliyuncs.com/md/image-20230608103804470.png)

### 文件下载

#### 使用`ResponseEntity`

> `ResponseEntity`返回类型：`ResponseEntity`是Spring框架提供的一个通用的HTTP响应实体类，可以用于返回响应状态码、响应头、响应内容等信息。您可以使用`ResponseEntity`构造方法来创建一个包含响应内容的实例，然后返回该实例。这种方式更加灵活，可以在响应中设置状态码、响应头等信息，同时也可以返回其他类型的数据或自定义响应体。

```java
   @GetMapping("/{fileName}")
    public ResponseEntity<Resource> downloadFile(@PathVariable String fileName) throws IOException {
        // 获取要下载的文件路径
        String filePath = "src/main/java/com/whn/testdemo/" + fileName;
        System.out.println(filePath);
        // 创建文件对象
        File file = new File(filePath);
        // 检查文件是否存在
        if (!file.exists()) {
            System.out.println("不存在！");
            return ResponseEntity.notFound().build();
        }
        System.out.println(fileName+"存在！");
        System.out.println("地址"+file.getAbsolutePath());
        // 使用Spring的FileSystemResource封装文件
        Resource resource = new FileSystemResource(file);

        // 创建响应头，指定文件下载的名称
        HttpHeaders headers = new HttpHeaders();
        headers.setContentDispositionFormData("attachment", fileName);
        headers.setContentType(MediaType.APPLICATION_OCTET_STREAM);

        // 返回带有文件内容和响应头的ResponseEntity
        return new ResponseEntity<>(resource, headers, HttpStatus.OK);
    }
```

上述代码中`new File(filePath)`地址采用相对地址，在项目根目录下

![image-20230608151831363](https://wang-rich.oss-cn-hangzhou.aliyuncs.com/md/image-20230608151831363.png)

#### 运行

> 在swagger中传入`src/main/java/com/whn/testdemo/`地址下的文件名称

![image-20230608151915272](https://wang-rich.oss-cn-hangzhou.aliyuncs.com/md/image-20230608151915272.png)

>  控制台显示

![image-20230608152124074](https://wang-rich.oss-cn-hangzhou.aliyuncs.com/md/image-20230608152124074.png)